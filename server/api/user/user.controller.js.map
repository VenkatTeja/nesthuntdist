{"version":3,"sources":["api/user/user.controller.js"],"names":["index","create","show","shortlist","destroy","editBuilderProfile","changePassword","me","authCallback","validationError","res","statusCode","err","status","json","handleError","send","req","find","exec","then","users","catch","newUser","body","provider","role","message","save","user","token","sign","_id","secrets","session","expiresIn","next","userId","params","id","findById","end","profile","indexOf","push","splice","deepPopulate","findByIdAndRemove","data","key","i","length","hasOwnProperty","isEmpty","isLength","phone","min","max","isInt","cin","console","log","name","lastname","owner","attorney","address","website","pan","oldPass","String","oldPassword","newPass","newPassword","authenticate","password","redirect"],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\n\nimport User from './user.model';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\nimport validator from 'validator';\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    return res.status(statusCode).json(err);\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    return res.status(statusCode).send(err);\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexport function index(req, res) {\n  return User.find({}, '-salt -password').exec()\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Creates a new user\n */\nexport function create(req, res) {\n  var newUser = new User(req.body);\n  newUser.provider = 'local';\n\n  if(newUser.role=='admin')\n    return res.send(400,{message:\"Bad Request\"});\n  newUser.save()\n    .then(function(user) {\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n        expiresIn: 60 * 60 * 5\n      });\n      res.json({ token:token, _id:user._id });\n    })\n    .catch(validationError(res));\n}\n\n/**\n * Get a single user\n */\nexport function show(req, res, next) {\n  var userId = req.params.id;\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if(!user) {\n        return res.status(404).end();\n      }\n      res.json(user.profile);\n    })\n    .catch(err => next(err));\n}\n\nexport function shortlist(req, res){\n  var index  = req.user.shortlist.indexOf(req.params.id);\n  if(index<0)\n    req.user.shortlist.push(req.params.id);\n  else\n    req.user.shortlist.splice(index, 1);\n\n  return req.user.save()\n    .then(function(){\n      User.findById(req.user._id)\n      .deepPopulate('shortlist.type')\n      .exec()\n      .then(user=>{\n        res.json(user.shortlist);\n      })\n    })\n    .catch(handleError(res));\n}\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexport function destroy(req, res) {\n  return User.findByIdAndRemove(req.params.id).exec()\n    .then(function() {\n      res.status(204).end();\n    })\n    .catch(handleError(res));\n}\n\n\n/* editBuilderProfile */\nexport function editBuilderProfile(req, res){\n  var body = req.body.data;\n  if(req.user.role=='builder')\n    var key = [\"name\", \"owner\", \"phone\", \"address\", \"cin\", \"website\"];\n  else\n    var key = [\"name\", \"lastname\", \"phone\", \"address\"];\n\n  for(var i=0;i<key.length;++i)\n    if(body.hasOwnProperty(key[i])){\n      body[key[i]] += '';\n      if(validator.isEmpty(body[key[i]]))\n        return res.send(400,{message: key+\" is empty\"});\n    }\n  if(!validator.isLength(body.phone, {min:10,max:10}))\n    return res.send(400,{message: \"Phone number 10 digits only\"});\n  if(!validator.isInt(body.phone))\n    return res.send(400,{message: \"Phone number is number only\"});\n  if(req.user.role=='builder'){\n    if(!validator.isLength(body.cin, {min:21,max:21}))\n      return res.send(400,{message: \"CIN 21 digits only\"});\n  }\n  // Checks passed\n\n  return User.findById(req.user._id).exec()\n    .then(function(user){\n      console.log(user,22243);\n      user.name = body.name;\n      user.lastname = body.lastname;\n      user.owner = body.owner;\n      user.attorney = body.attorney;\n      user.cin = body.cin;\n      user.phone = body.phone;\n      user.address = body.address;\n      user.website = body.website;\n      user.pan = body.pan;\n      user.save().then(()=>{\n        res.status(204).end();\n      })\n      .catch(validationError(res));\n    })\n    .catch(validationError(res));\n}\n/**\n * Change a users password\n */\nexport function changePassword(req, res) {\n  var userId = req.user._id;\n  var oldPass = String(req.body.oldPassword);\n  var newPass = String(req.body.newPassword);\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if(user.authenticate(oldPass)) {\n        user.password = newPass;\n        return user.save()\n          .then(() => {\n            res.status(204).end();\n          })\n          .catch(validationError(res));\n      } else {\n        return res.status(403).end();\n      }\n    });\n}\n\n/**\n * Get my info\n */\nexport function me(req, res, next) {\n  var userId = req.user._id;\n\n  return User.findById(userId, '-salt -password')\n    .deepPopulate('shortlist.type')\n    .exec()\n    .then(user => { // don't ever give out the password or salt\n      if(!user) {\n        return res.status(401).end();\n      }\n      res.json(user);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Authentication callback\n */\nexport function authCallback(req, res) {\n  res.redirect('/');\n}\n"]}